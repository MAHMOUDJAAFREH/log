<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسجيل الحضور وإدارة الدورات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
body {
            font-family: 'Cairo', sans-serif;
            min-height: 100vh;
}
        /* تعديلات نمط خاصة للنموذج */
        input:focus, select:focus {
            border-color: #3b82f6 !important;
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .rtl-input::placeholder {
            text-align: right;
}
    </style>
</head>
<body class="bg-gray-50 flex items-start justify-center p-4">

    <div id="appContainer" class="w-full max-w-lg md:max-w-4xl bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-blue-100 transition-all duration-300 mt-8">

        <header class="mb-6 border-b pb-4 border-blue-200 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-700 mb-1 leading-tight" id="mainTitle">نموذج تسجيل 
الحضور</h1>
                <h2 class="text-lg font-medium text-gray-600">شعبة التعليم والتدريب والتطوير الفني والإداري</h2>
            </div>
            <button id="viewToggle" onclick="window.switchView('admin')"
                    class="bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
  
لوحة المشرف
            </button>
        </header>

        <div class="mb-4 text-xs text-gray-500 bg-gray-100 p-2 rounded hidden" id="userIdDisplay">
            <span class="font-semibold text-gray-700">معرف المستخدم (للتتبع):</span> <span id="currentUserId">N/A</span>
        </div>

      
  <div id="messageBox" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-40 hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
            <div id="messageContent" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center transform transition-transform duration-300 scale-95">
                <h3 id="messageTitle" class="text-xl font-bold mb-3"></h3>
                <p id="messageBody" class="text-gray-700 mb-4"></p>
    
            <button onclick="document.getElementById('messageBox').classList.add('hidden', 'opacity-0');
document.getElementById('messageBox').classList.remove('opacity-100');"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150">
                    حسناً
                </button>
            </div>
        </div>
        
     
   <div id="confirmBox" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-40 hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center transform transition-transform duration-300 scale-95" dir="rtl">
                <h3 class="text-xl font-bold mb-3 text-red-600">تأكيد الحذف</h3>
                <p id="confirmBody" class="text-gray-700 mb-4"></p>
  
               <div class="flex justify-center space-x-4 space-x-reverse">
                    <button id="confirmYes" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150">
                        نعم، احذف
                    </button>
        
            <button id="confirmNo" onclick="document.getElementById('confirmBox').classList.add('hidden', 'opacity-0');
document.getElementById('confirmBox').classList.remove('opacity-100');"
                            class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150">
                        إلغاء
                    </button>
                </div>
     
        </div>
        </div>

        <div id="userView">

            <p class="text-sm italic text-gray-500 mt-2 mb-4">الرجاء تسجيل المعلومات بدقة واكتمال.</p>

            <div class="required-note p-3 bg-red-50 text-red-700 border-r-4 border-red-400 rounded-lg mb-6 text-sm">
                الأسئلة التي تحمل علامة (<span class="text-red-600 font-bold">*</span>) هي أسئلة إلزامية.
            </div>

            <form id="attendanceForm" class="space-y-5">

                <div class="form-group">
                    <label for="courseName" class="block text-sm font-semibold text-gray-700 mb-2">اسم الدورة أو المحاضرة <span class="text-red-500">*</span></label>
                    <select id="courseName" name="courseName" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 
transition duration-150 bg-white cursor-pointer"
                            disabled>
                        <option value="" disabled selected>-- الرجاء اختيار اسم الدورة --</option>
                        </select>
                </div>
                
                <div class="form-group">
                
     <label for="employeeIdEn" class="block text-sm font-semibold text-gray-700 mb-2">الرقم الوظيفي (باللغة الإنجليزية) <span class="text-red-500">*</span></label>
                    <input type="text" id="employeeIdEn" name="employeeIdEn" required pattern="[0-9]*" inputmode="numeric"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                       
     dir="ltr" placeholder="Example: 12345">
                </div>

                <div class="form-group">
                    <label for="nameAr" class="block text-sm font-semibold text-gray-700 mb-2">الاسم الثلاثي باللغة العربية <span class="text-red-500">*</span></label>
         
            <input type="text" id="nameAr" name="nameAr" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           placeholder="أدخل اسمك الثلاثي">
                </div>

     
            <div class="form-group">
                    <label for="nameEn" class="block text-sm font-semibold text-gray-700 mb-2">الاسم الثلاثي باللغة الإنجليزية (لغايات ساعات التطوير المهني)</label>
                    <input type="text" id="nameEn" name="nameEn"
           
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                           dir="ltr" placeholder="Enter your full name">
                </div>
                
            
     <div class="form-group">
                    <label for="nationalIdEn" class="block text-sm font-semibold text-gray-700 mb-2">الرقم الوطني باللغة الإنجليزية <span class="text-red-500">*</span></label>
                    <input type="text" id="nationalIdEn" name="nationalIdEn" required pattern="[0-9]*" inputmode="numeric"
                  
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                           dir="ltr" placeholder="Example: 9876543210">
                </div>

                <div class="form-group space-y-3">
                    <label for="workPlace" class="block text-sm font-semibold text-gray-700 mb-2">مكان العمل <span class="text-red-500">*</span></label>
                    <select id="workPlace" name="workPlace" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-white cursor-pointer">
       
                  <option value="" disabled selected>-- الرجاء اختيار مكان العمل --</option>
                        <option value="دائرة الباطنية">دائرة الباطنية</option>
                        <option value="دائره طب الاسنان">دائرة طب الأسنان</option>
                   
          <option value="دائرة المختبرات الطبية والطب الشرعي">دائرة المختبرات الطبية والطب الشرعي</option>
                        <option value="دائرة الخدمات الطبية المساندة">دائرة الخدمات الطبية المساندة</option>
                        <option value="دائرة التخدير والانعاش">دائرة التخدير والإنعاش</option>
                        <option value="دائرة 
 الاشعه والطب النووي">دائرة الأشعة والطب النووي</option>
                        <option value="دائرة طب التاهيل">دائرة طب التأهيل</option>
                        <option value="مكتب البحث العلمي والدراسات الدوائية">مكتب البحث العلمي والدراسات الدوائية</option>
                        <option value="دائرة الصيدلة / بكالوريس صيدلة - د.صيدله">دائرة الصيدلة 
 / بكالوريوس صيدلة - د. صيدلة</option>
                        <option value="دائرة الصيدلة / دبلوم">دائرة الصيدلة / دبلوم</option>
                        <option value="دائرة الشؤون المالية">دائرة الشؤون المالية</option>
                        <option value="مكتب الجودة ومراقبة النوعية">مكتب الجودة ومراقبة النوعية</option>
    
                     <option value="مكتب السيطرة على العدوى">مكتب السيطرة على العدوى</option>
                        <option value="مكتب السلامة العامة والبيئة">مكتب السلامة العامة والبيئة</option>
                        <option value="دائرة الموارد البشرية">دائرة الموارد البشرية</option>
             
            <option value="مكتب العلاقات العامة">مكتب العلاقات العامة</option>
                        <option value="مكتب المعلومات والحاسوب">مكتب المعلومات والحاسوب</option>
                        <option value="مكتب الرقابة والتدقيق">مكتب الرقابة والتدقيق</option>
                        <option value="دائرة 
 العطاءات والتزويد">دائرة العطاءات والتزويد</option>
                        <option value="دائرة الهندسة والصيانة والتشغيل">دائرة الهندسة والصيانة والتشغيل</option>
                        <option value="دائرة شؤون المرضى">دائرة شؤون المرضى</option>
                        <option value="دائرة الخدمات المساندة">دائرة الخدمات المساندة</option>
        
                 <option value="دائرة الخدمات الفندقية">دائرة الخدمات الفندقية</option>
                        <option value="موظف جامعة اردنية">موظف جامعة أردنية</option>
                        <option value="OTHER">أخرى (يرجى التحديد)</option>
                    </select>

   
                  <input type="text" id="workPlaceOther" name="workPlaceOther" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 hidden"
                  
          placeholder="الرجاء تحديد مكان العمل الآخر" 
                           data-original-name="workPlace"> 
                </div>

                <div class="form-group">
     
                <label for="jobTitle" class="block text-sm font-semibold text-gray-700 mb-2">المسمى الوظيفي</label>
                    <input type="text" id="jobTitle" name="jobTitle"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                    
        placeholder="حسب ما هو مكتوب في الباجة التعريفية">
                </div>
                
                <div class="form-group space-y-3">
               
      <label for="qualification" class="block text-sm font-semibold text-gray-700 mb-2">درجة المؤهل العلمي <span class="text-red-500">*</span></label>
                    <select id="qualification" name="qualification" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-white cursor-pointer">
                        
<option value="" disabled selected>-- اختر درجة المؤهل --</option>
                        <option value="دبلوم">دبلوم</option>
                        <option value="بكالوريوس">بكالوريوس</option>
                        <option value="دراسات عليا">دراسات عليا (ماجستير/دكتوراه)</option>
               
          <option value="OTHER_QUAL">أخرى (يرجى التحديد)</option>
                    </select>

                    <input type="text" id="qualificationOther" name="qualificationOther" 
                  
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 hidden"
                           placeholder="الرجاء تحديد المؤهل العلمي الآخر" 
                           data-original-name="qualification">
                </div>

       
          <div class="form-group">
                    <label for="phoneEn" class="block text-sm font-semibold text-gray-700 mb-2">رقم الهاتف (باللغة الإنجليزية)</label>
                    <input type="tel" id="phoneEn" name="phoneEn" pattern="[0-9]*" inputmode="tel"
             
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                           dir="ltr" placeholder="Example: 79xxxxxxx">
                </div>
                
                
 <div class="form-group">
                    <label for="signature" class="block text-sm font-semibold text-gray-700 mb-2">التوقيع (الرقم الوظيفي بالإنجليزية) <span class="text-red-500">*</span></label>
                    <input type="text" id="signature" name="signature" required pattern="[0-9]*" inputmode="numeric"
                   
         class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                           dir="ltr" placeholder="أعد إدخال الرقم الوظيفي للتوقيع">
                </div>

                <button type="submit" id="submitButton"
                        class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-green-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-500/50 flex items-center justify-center disabled:opacity-50"
                        disabled>
                    <span id="buttonText">تسجيل الحضور</span>
         
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 
 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>

        <div id="adminView" class="hidden max-w-full md:max-w-4xl" style="direction: ltr;">
            <button onclick="window.switchView('user')"
                    class="bg-gray-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-150 mb-6 shadow-md"
                    dir="rtl">
                <span class="inline-block transform rotate-180 mr-2">⮞</span>
         
        العودة لنموذج الحضور
            </button>

            <div class="bg-blue-50 p-6 rounded-xl mb-8 border-l-4 border-blue-400">
                <h3 class="text-xl font-bold text-blue-700 mb-4" dir="rtl">إدارة الدورات / المحاضرات</h3>
                <form id="courseForm" class="flex flex-col md:flex-row 
 gap-3" dir="rtl">
                    <input type="text" id="newCourseName" required placeholder="أدخل اسم الدورة الجديدة"
                           class="flex-grow p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right"
                           dir="rtl">
           
          <button type="submit" id="addCourseButton"
                            class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50 min-w-[150px]">
                        إضافة دورة
                    </button>
  
               </form>
                <div class="mt-4 p-3 bg-white rounded-lg shadow-inner">
                    <h4 class="font-semibold text-gray-700 mb-2" dir="rtl">الدورات الحالية:</h4>
                    <ul id="courseList" class="space-y-1 text-sm text-gray-600" dir="rtl">
               
          <li class="text-center text-gray-400">جاري التحميل...</li>
                    </ul>
                </div>
            </div>

         
    <div class="mt-8">
                <div class="flex justify-between items-center mb-4" dir="rtl">
                    <h3 class="text-xl font-bold text-gray-700">سجلات الحضور (<span id="recordCount">0</span> تسجيل)</h3>
                    <button id="exportButton" onclick="window.exportRecordsToSheet()"
                            class="bg-purple-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center disabled:opacity-50"
                            title="تصدير جميع السجلات مباشرة إلى Google Sheets">
            
             <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M12 18V12"/><path d="M9 15h6"/></svg>
                        تصدير مباشر لـ Sheets
                    </button>
    
                 </div>
                <div class="overflow-x-auto bg-white rounded-lg shadow-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200 text-right text-sm" dir="rtl">
                
         <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">التاريخ</th>
                          
       <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">اسم الدورة</th> <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">الرقم الوظيفي</th>
                                <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">الاسم (عربي)</th>
        
                         <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">مكان العمل</th>
                            </tr>
                        </thead>
                  
       <tbody id="attendanceRecordsTable" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">جاري تحميل السجلات...</td></tr>
                        </tbody>
                    </table>
            
     </div>
            </div>
        </div>

    </div>

    <script type="module">
        // ----------------------------------------------------------------
        // NOTE: Firebase Config and App ID are now hardcoded based on user's request.
// ----------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBRbLWcAFNAGHAIi5DRwCGDp4f7o4H4ZP8",
            authDomain: "attendance-training-log.firebaseapp.com",
            projectId: "attendance-training-log",
            storageBucket: "attendance-training-log.firebasestorage.app",
            messagingSenderId: "281858319933",
            appId: "1:281858319933:web:dd2b5b6af852b65ac2ac54"
        };
// ***************************************************************
        // ** التعديل الهام: تم وضع رابط النشر لسكريبت Google Apps Script هنا **
        // ***************************************************************
        const GOOGLE_SHEETS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbysm_czs0mxTumCBUcfxTSf3XmMFiwbCu4X6HE8G9HnckbGHd-ZY9pYc7UzoDwAZm2z2g/exec';
// ***************************************************************

        // Global variables provided by the environment (using project ID as app ID for simplicity here)
        const appId = typeof __app_id !== 'undefined' ?
 __app_id : 'default-app-id';
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
// Firebase Imports (using mandated version 11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
 import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
 import { getFirestore, collection, addDoc, setLogLevel, onSnapshot, query, serverTimestamp, getDocs, where, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
 import { query as firestoreQuery } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');
// Initialize Firebase variables
        let app, db, auth, userId = 'anonymous';
 let isReady = false; 

        // Global variable to hold records for export
        let currentRecords = [];
// مسارات Firestore الآمنة التي تتطابق مع قواعد الأمان في بيئة Canvas
        // --- START MODIFICATION ---
        // When running outside the Canvas environment (e.g., as a local file),
        // we use simple root collection names instead of the complex Canvas path.
 const ATTENDANCE_COLLECTION = 'attendance_records'; // اسم المجموعة المحلي
        const COURSES_COLLECTION = 'courses';
// اسم المجموعة المحلي
        
        // Check if we are in the Canvas environment by checking __app_id
        const isCanvasEnvironment = typeof __app_id !== 'undefined' && __app_id !== 'default-app-id';
 const getCollectionPath = (collectionName) => {
            if (isCanvasEnvironment) {
                return `/artifacts/${appId}/public/data/${collectionName}`;
 }
            // Use simple root collection name if not in Canvas
            return collectionName;
 };
        
        const ATTENDANCE_COLLECTION_PATH = getCollectionPath(ATTENDANCE_COLLECTION);
        const COURSES_COLLECTION_PATH = getCollectionPath(COURSES_COLLECTION);
        // --- END MODIFICATION ---


        // UI elements
        const employeeIdInput = document.getElementById('employeeIdEn');
 const nameArInput = document.getElementById('nameAr');
        const nameEnInput = document.getElementById('nameEn');
        const nationalIdInput = document.getElementById('nationalIdEn');
        const workPlaceSelect = document.getElementById('workPlace'); 
        const workPlaceOtherInput = document.getElementById('workPlaceOther');
 const jobTitleInput = document.getElementById('jobTitle');
        const phoneEnInput = document.getElementById('phoneEn');
        const qualificationSelect = document.getElementById('qualification'); 
        const qualificationOtherInput = document.getElementById('qualificationOther'); 
        
        const userView = document.getElementById('userView');
 const adminView = document.getElementById('adminView');
        const mainTitle = document.getElementById('mainTitle');
        const viewToggle = document.getElementById('viewToggle');
        const form = document.getElementById('attendanceForm');
        const courseForm = document.getElementById('courseForm');
 const courseNameSelect = document.getElementById('courseName');
        const courseListUl = document.getElementById('courseList');
        const recordsTableBody = document.getElementById('attendanceRecordsTable');
        const recordCountSpan = document.getElementById('recordCount');
        const submitButton = document.getElementById('submitButton');
 const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const exportButton = document.getElementById('exportButton');
// Global variable to store confirmation callback
        let confirmCallback = null;
// Event listener for the "Yes" button in the confirm modal
        document.getElementById('confirmYes')?.addEventListener('click', () => {
            document.getElementById('confirmBox').classList.add('hidden', 'opacity-0');
            document.getElementById('confirmBox').classList.remove('opacity-100');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
      
       }
        });
// Function to show custom modal messages
        const showMessage = (title, body, isSuccess = false) => {
            const messageBox = document.getElementById('messageBox');
 const messageTitle = document.getElementById('messageTitle');
            const messageBody = document.getElementById('messageBody');
            const button = messageBox.querySelector('button');

            messageTitle.textContent = title;
            messageBody.textContent = body;
// Set style based on success/error
            messageTitle.classList.remove('text-red-600', 'text-green-600');
 button.classList.remove('bg-blue-600', 'bg-green-600');

            if (isSuccess) {
                messageTitle.classList.add('text-green-600');
 button.classList.add('bg-green-600');
            } else {
                messageTitle.classList.add('text-red-600');
 button.classList.add('bg-blue-600');
            }

            // Show the modal
            messageBox.classList.remove('hidden');
 setTimeout(() => messageBox.classList.add('opacity-100'), 10);
        };
        
        // Function to show custom confirmation modal
        const showConfirm = (body, onConfirm) => {
            const confirmBox = document.getElementById('confirmBox');
 document.getElementById('confirmBody').textContent = body;
            confirmCallback = onConfirm;

            confirmBox.classList.remove('hidden');
            setTimeout(() => confirmBox.classList.add('opacity-100'), 10);
        };
/**
         * Helper function to generate action buttons for a course item.
 * تم تعريفها كـ window.function لجعلها متاحة لـ onclick في العناصر التي يتم إنشاؤها ديناميكياً.
 */
        window.getCourseActionButtons = (id, name) => {
            const escapedName = name.replace(/'/g, "\\'");
 return `
                <button onclick="window.handleEditCourse('${id}', '${escapedName}')" 
                        class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition duration-150" title="تعديل">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 
 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                </button>
                <button onclick="window.handleDeleteCourse('${id}', '${escapedName}')" 
                        class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150" title="حذف">
               
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            
 `;
        };


        /**
         * Switches the application view between 'user' and 'admin'.
 */
        window.switchView = (view) => {
            if (view === 'admin') {
                userView.classList.add('hidden');
 adminView.classList.remove('hidden');
                mainTitle.textContent = 'لوحة تحكم المشرف';
                viewToggle.textContent = 'نموذج الحضور';
                viewToggle.onclick = () => window.switchView('user');
                document.getElementById('userIdDisplay').classList.remove('hidden');
                document.getElementById('currentUserId').textContent = userId;
 } else { // user view
                adminView.classList.add('hidden');
 userView.classList.remove('hidden');
                mainTitle.textContent = 'نموذج تسجيل الحضور';
                viewToggle.textContent = 'لوحة المشرف';
                viewToggle.onclick = () => window.switchView('admin');
                document.getElementById('userIdDisplay').classList.add('hidden');
 }
        };

        /**
         * Loads courses from Firestore and populates the select dropdown and Admin list.
 */
        const loadCourses = () => {
            if (!db) return;
 const q = query(collection(db, COURSES_COLLECTION_PATH));
            
            // onSnapshot for real-time updates
            onSnapshot(q, (snapshot) => {
                const courses = [];
                const courseDocs = {}; // Store docId and name for CRUD operations
                snapshot.forEach((doc) => {
            
         const data = doc.data();
                    courses.push(data.name);
                    courseDocs[data.name] = { id: doc.id, name: data.name };
                });

                // 1. Populate User Dropdown
      
           courseNameSelect.innerHTML = '<option value="" disabled selected>-- الرجاء اختيار اسم الدورة --</option>';
                courses.sort().forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                 
    option.textContent = course;
                    courseNameSelect.appendChild(option);
                });
                
                // تم تمكين زر الإرسال بناءً على جاهزية النظام
                submitButton.disabled = !isReady 
 || courses.length === 0; 
                courseNameSelect.disabled = false;

                // 2. Populate Admin List
                courseListUl.innerHTML = '';
 if (courses.length > 0) {
                    courses.sort().forEach(courseName => {
                        const course = courseDocs[courseName];
                        const li = document.createElement('li');
                    
     li.id = `course-item-${course.id}`;
                        li.className = "flex items-center justify-between border-b last:border-b-0 py-2 group";
                        li.dir = "rtl"; // Ensure proper RTL alignment
                        
       
                  // --- START OF MODIFICATION ---
                        // SIMPLIFIED: Always render the standard view.
                        // This prevents data conflicts during real-time updates if an item is being edited.
          
                // Any in-progress edit will be safely cancelled by the snapshot re-render.
                        li.innerHTML = `
                            <span id="course-name-${course.id}" class="truncate text-base font-medium text-gray-800">${course.name}</span>
                
             <div id="course-actions-${course.id}" class="flex space-x-2 space-x-reverse min-w-[50px] items-center justify-end">
                                ${window.getCourseActionButtons(course.id, course.name)}
                            </div>
                    
     `;
                        // --- END OF MODIFICATION ---

                        courseListUl.appendChild(li);
 });
                } else {
                    courseListUl.innerHTML = '<li class="text-center py-2 text-gray-400">لا توجد دورات مسجلة بعد.</li>';
 }

                console.log(`Loaded ${courses.length} courses.`);
 }, (error) => {
                console.error("Error loading courses:", error);
 showMessage("خطأ في الدورات", "فشل تحميل قائمة الدورات. يرجى التأكد من أن الاتصال بالإنترنت فعال.", false);
            });
        };
/**
         * Handles deleting a course from Firestore using a custom confirmation modal.
 */
        window.handleDeleteCourse = async (courseId, courseName) => {
            showConfirm(
                `هل أنت متأكد من حذف الدورة: "${courseName}"؟ سيؤدي هذا إلى إزالة الدورة من قائمة الاختيارات لجميع المستخدمين، لكنه لن يحذف سجلات الحضور السابقة التي تستخدمها.`,
                async () => {
               
      // Logic executed on confirmation
                    const courseItem = document.getElementById(`course-item-${courseId}`);
                    if (courseItem) {
                        courseItem.style.opacity = '0.5';
                    
    courseItem.style.pointerEvents = 'none';
                    }

                    try {
                        await deleteDoc(doc(db, COURSES_COLLECTION_PATH, courseId));
                        showMessage("تم الحذف 
 بنجاح", `تم حذف الدورة: "${courseName}".`, true);
                    } catch (error) {
                        console.error("Error deleting course: ", error);
                        showMessage("خطأ في الحذف", `حدث خطأ أثناء حذف الدورة: ${error.message}.`, false);
 }
                    // The onSnapshot listener handles the final UI removal/re-render.
 }
            );
        };
/**
         * Enables inline editing for a course name by replacing the text span with an input field.
 */
        window.handleEditCourse = (courseId, currentName) => {
            const nameSpan = document.getElementById(`course-name-${courseId}`);
 const actionsDiv = document.getElementById(`course-actions-${courseId}`);
            const listItem = document.getElementById(`course-item-${courseId}`);

            if (!nameSpan || !actionsDiv || !listItem) return;
// Hide the original span
            nameSpan.classList.add('hidden');
// Create input field
            const input = document.createElement('input');
 input.type = 'text';
            input.value = currentName;
            input.id = `edit-input-${courseId}`;
            input.className = 'flex-grow p-1 border border-blue-400 rounded-lg text-right focus:ring-blue-500 focus:border-blue-500';
 input.dir = 'rtl';
            input.required = true;

            // Create temporary div to hold input
            const tempEditDiv = document.createElement('div');
 tempEditDiv.id = `edit-div-${courseId}`;
            tempEditDiv.className = "flex flex-grow items-center gap-2";
            tempEditDiv.appendChild(input);
// Insert input field before action buttons
            listItem.insertBefore(tempEditDiv, actionsDiv);
// Change action buttons to Save and Cancel
            // Note: The cancel button now calls loadCourses() to force a re-render from snapshot,
            // which is safer and guaranteed to clean up the edit state.
 actionsDiv.innerHTML = `
                <button onclick="window.handleSaveEdit('${courseId}', '${currentName.replace(/'/g, "\\'")}')" 
                        class="text-green-500 hover:text-green-700 p-1 rounded-full hover:bg-green-100 transition duration-150" title="حفظ التعديل">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="20 6 9 17 4 12"/></svg>
      
           </button>
                <button onclick="window.loadCourses()" 
                        class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150" title="إلغاء">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" 
 y1="6" y2="18"/></svg>
                </button>
            `;
 input.focus();
        };

        /**
         * Saves the edited course name to Firestore.
 */
        window.handleSaveEdit = async (courseId, originalName) => {
            const input = document.getElementById(`edit-input-${courseId}`);
 const actionsDiv = document.getElementById(`course-actions-${courseId}`);

            if (!input || !input.value.trim()) {
                showMessage("خطأ في البيانات", "لا يمكن حفظ اسم دورة فارغ.", false);
 return;
            }
            
            const newName = input.value.trim();
 if (newName === originalName) {
                showMessage("إلغاء التعديل", "لم يتم حفظ التعديل: الاسم الجديد مطابق للاسم القديم.", false);
// Trigger re-render to clean up edit fields
                loadCourses();
 return;
            }
            
            input.disabled = true;
 actionsDiv.style.opacity = '0.5'; 

            try {
                // Check for duplication before updating
                const existingCourseQuery = firestoreQuery(collection(db, COURSES_COLLECTION_PATH), where('name', '==', newName));
 const existingSnapshot = await getDocs(existingCourseQuery);

                if (!existingSnapshot.empty) {
                    // Check if the found document is the one we are editing.
 If not, it's a duplicate.
                    let isDuplicate = false;
                    existingSnapshot.forEach(doc => {
                        if (doc.id !== courseId) {
                            isDuplicate = true;
                        }
       
              });
 if (isDuplicate) {
                        showMessage("خطأ", `الدورة "${newName}" موجودة بالفعل لدورة أخرى.`, false);
 input.disabled = false;
                        actionsDiv.style.opacity = '1';
                        return;
                    }
                }


                await updateDoc(doc(db, COURSES_COLLECTION_PATH, courseId), {
                    name: newName,
                    updatedAt: serverTimestamp() 
              
   });

                showMessage("تم الحفظ بنجاح", `تم تعديل اسم الدورة من "${originalName}" إلى "${newName}".`, true);
// The onSnapshot listener handles the final UI refresh.
                
            } catch (error) {
                console.error("Error saving course edit: ", error);
 showMessage("خطأ في الحفظ", `حدث خطأ أثناء حفظ التعديل: ${error.message}.`, false);
 } finally {
                // In case of error, re-enable (though onSnapshot will refresh anyway)
                input.disabled = false;
 actionsDiv.style.opacity = '1';
                // We don't call loadCourses() here because the onSnapshot listener 
                // will fire upon successful updateDoc and handle the UI refresh.
 }
        };

        /**
         * Handles adding a new course to Firestore.
 */
        const handleAddCourse = async (event) => {
            event.preventDefault();
 const newCourseInput = document.getElementById('newCourseName');
            const courseName = newCourseInput.value.trim();
            const addCourseButton = document.getElementById('addCourseButton');

            if (!courseName) return;

            addCourseButton.disabled = true;
 addCourseButton.textContent = "جاري الإضافة...";

            try {
                // Check if course already exists (case-insensitive for a simple check)
                const existingCourseQuery = firestoreQuery(collection(db, COURSES_COLLECTION_PATH), where('name', '==', courseName));
 const existingSnapshot = await getDocs(existingCourseQuery);
                
                if (!existingSnapshot.empty) {
                    showMessage("خطأ", `الدورة "${courseName}" موجودة بالفعل.`, false);
 return;
                }
                
                await addDoc(collection(db, COURSES_COLLECTION_PATH), {
                    name: courseName,
                    createdAt: serverTimestamp() 
                });
 showMessage("تم بنجاح", `تم إضافة الدورة: "${courseName}"`, true);
                newCourseInput.value = '';
// Clear input
            } catch (error) {
                console.error("Error adding course: ", error);
 showMessage("خطأ في الإضافة", `حدث خطأ أثناء إضافة الدورة: ${error.message}.`, false);
 } finally {
                addCourseButton.disabled = false;
 addCourseButton.textContent = "إضافة دورة";
            }
        };
/**
         * Loads attendance records from Firestore for the Admin view.
 */
        const loadAttendanceRecords = () => {
            if (!db) return;
// Query without orderBy to avoid index requirement
            const q = query(collection(db, ATTENDANCE_COLLECTION_PATH));
// onSnapshot for real-time updates
            onSnapshot(q, (snapshot) => {
                recordsTableBody.innerHTML = '';
                
                currentRecords = []; // Clear global records
                snapshot.forEach((doc) => {
       
              currentRecords.push(doc.data());
                });

                // Sort by timestamp descending (in-memory sort required since orderBy is avoided)
                currentRecords.sort((a, b) => {
                    const timeA = b.timestamp?.toDate ? 
 b.timestamp.toDate().getTime() : 0;
                    const timeB = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
                    return timeA - timeB; // Sort descending
                });

                recordCountSpan.textContent = currentRecords.length;
           
       exportButton.disabled = currentRecords.length === 0;

                if (currentRecords.length === 0) {
                    recordsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">لا توجد سجلات حضور مسجلة.</td></tr>';
 return;
                }

                currentRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 transition duration-100';

                    // Format timestamp
            
         const date = record.timestamp?.toDate ? record.timestamp.toDate() : new Date();
                    const formattedDate = date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    // NEW TABLE ORDER: Date, Course Name, Employee ID, 
 Name Ar, Work Place
                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap">${formattedDate}</td>
                        <td class="px-3 py-3 whitespace-nowrap">${record.courseName || '---'}</td>
                   
       <td class="px-3 py-3 whitespace-nowrap text-left" dir="ltr">${record.employeeIdEn || '---'}</td>
                        <td class="px-3 py-3 whitespace-nowrap font-medium">${record.nameAr ||
 '---'}</td>
                        <td class="px-3 py-3 whitespace-nowrap">${record.workPlace ||
 '---'}</td>
                    `;
 recordsTableBody.appendChild(row);
                });

                console.log(`Loaded ${currentRecords.length} attendance records.`);

            }, (error) => {
                console.error("Error loading attendance records:", error);
 recordsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">خطأ في تحميل السجلات.</td></tr>';
 showMessage("خطأ في السجلات", "فشل تحميل سجلات الحضور. يرجى التأكد من أن الاتصال بالإنترنت فعال.", false);
            });
        };
/**
         * Sends data to the Google Sheets Web App URL.
 */
        window.exportRecordsToSheet = async () => {
            if (!GOOGLE_SHEETS_SCRIPT_URL) {
                showMessage("خطأ في الإعداد", "لم يتم تعيين رابط Google Sheets Script URL في الكود.", false);
 return;
            }
            if (currentRecords.length === 0) {
                showMessage("لا توجد بيانات", "لا توجد سجلات حضور لتصديرها.", false);
 return;
            }

            exportButton.disabled = true;
            const originalText = exportButton.textContent;
 exportButton.textContent = "جاري التصدير...";

            // Prepare records for sending, ensuring date is formatted correctly for Sheets
            const formattedRecords = currentRecords.map(record => {
                const date = record.timestamp?.toDate ? record.timestamp.toDate() : new Date();
                
                // Format date/time to include seconds for precise log
    
             const formattedDate = date.toLocaleDateString('ar-EG', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit' 
                });

               
  return {
                    // This order is crucial and must match DEFAULT_HEADERS in sheets_exporter.js
                    "التاريخ": formattedDate,
                    "اسم الدورة": record.courseName || '',
                    "الرقم الوظيفي": record.employeeIdEn 
 || '',
                    "الاسم (عربي)": record.nameAr || '',
                    "الاسم (إنجليزي)": record.nameEn || '',
                    "الرقم الوطني": record.nationalIdEn ||
 '',
                    "مكان العمل": record.workPlace ||
 '',
                    "المسمى الوظيفي": record.jobTitle ||
 '',
                    "المؤهل العلمي": record.qualification ||
 '',
                    "رقم الهاتف": record.phoneEn ||
 '',
                    "App ID": record.appId ||
 appId,
                    "User ID": record.userId ||
 userId
                };
            });
 try {
                const response = await fetch(GOOGLE_SHEETS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
            
         body: JSON.stringify({ records: formattedRecords })
                });
 const result = await response.json();

                if (result.status === 'success') {
                    showMessage("نجاح التصدير!", `تم ترحيل ${currentRecords.length} سجل بنجاح إلى جدول البيانات.`, true);
 } else {
                    console.error("Sheets Script Error:", result.message);
 showMessage("فشل التصدير", `فشل سكريبت Sheets: ${result.message || 'حدث خطأ غير معروف في السكريبت.'}`, false);
 }

            } catch (error) {
                console.error("Network/Fetch Error:", error);
 showMessage("خطأ في الاتصال", `فشل في إرسال البيانات إلى Google Sheets: ${error.message}. تأكد من تفعيل الرابط.`, false);
 } finally {
                exportButton.disabled = false;
 exportButton.textContent = originalText;
            }
        };
/**
         * Fetches user data based on employee ID and auto-fills the form.
 */
        const fetchUserDataByEmployeeId = async (event) => {
            const employeeId = event.target.value.trim();
// Clear fields if the input is empty or too short (assuming ID is 4+ digits)
            if (employeeId.length < 4 || !/^\d+$/.test(employeeId)) {
                // Clear fields only if they are not the current employee ID being typed
                if (nameArInput.value) nameArInput.value = '';
 if (nameEnInput.value) nameEnInput.value = '';
                if (nationalIdInput.value) nationalIdInput.value = '';
                if (workPlaceSelect.value) workPlaceSelect.value = ''; 
                workPlaceOtherInput.value = '';
// Clear workPlace other input
                workPlaceOtherInput.classList.add('hidden');
 workPlaceOtherInput.required = false; 
                if (jobTitleInput.value) jobTitleInput.value = '';
                if (phoneEnInput.value) phoneEnInput.value = '';
                if (qualificationSelect.value) qualificationSelect.value = '';
 qualificationOtherInput.value = ''; // Clear qualification other input
                qualificationOtherInput.classList.add('hidden');
 qualificationOtherInput.required = false;
                return;
            }

            try {
                // الاستعلام: ابحث عن جميع السجلات التي تطابق الرقم الوظيفي
                const q = firestoreQuery(
                    collection(db, ATTENDANCE_COLLECTION_PATH),
                  
   where('employeeIdEn', '==', employeeId)
                );
 const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const allRecords = [];
 snapshot.forEach(doc => allRecords.push(doc.data()));

                    // الفرز في الذاكرة (In-Memory Sort) للحصول على أحدث سجل
                    allRecords.sort((a, b) => {
                        const timeA = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
                        const timeB = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
   
                      return timeA - timeB; // Sort descending
                    });
 const latestRecord = allRecords[0]; // أحدث سجل هو العنصر الأول بعد الفرز
                    
                    // Auto-fill form fields with the latest data
                    if (latestRecord.nameAr) nameArInput.value = latestRecord.nameAr;
 if (latestRecord.nameEn) nameEnInput.value = latestRecord.nameEn;
                    if (latestRecord.nationalIdEn) nationalIdInput.value = latestRecord.nationalIdEn; 
                    if (latestRecord.jobTitle) jobTitleInput.value = latestRecord.jobTitle;
                    if (latestRecord.phoneEn) phoneEnInput.value = latestRecord.phoneEn;
// --- 1. Handle workPlace auto-fill logic ---
                    const workPlaceValue = latestRecord.workPlace ||
 '';
                    const predefinedWorkOptions = Array.from(workPlaceSelect.options).map(o => o.value);
                    const isWorkPredefined = predefinedWorkOptions.includes(workPlaceValue);
 if (isWorkPredefined) {
                        workPlaceSelect.value = workPlaceValue;
 workPlaceOtherInput.classList.add('hidden');
                        workPlaceOtherInput.required = false;
                        workPlaceOtherInput.value = '';
                    } else if (workPlaceValue) {
                        workPlaceSelect.value = 'OTHER';
 workPlaceOtherInput.classList.remove('hidden');
                        workPlaceOtherInput.required = true;
                        workPlaceOtherInput.value = workPlaceValue;
                    } else {
                        workPlaceSelect.value = '';
 workPlaceOtherInput.classList.add('hidden');
                        workPlaceOtherInput.required = false;
                        workPlaceOtherInput.value = '';
                    }
                    
                    // --- 2. Handle Qualification auto-fill logic ---
                    const qualValue = latestRecord.qualification ||
 '';
                    const predefinedQualOptions = Array.from(qualificationSelect.options).map(o => o.value);
                    const isQualPredefined = predefinedQualOptions.includes(qualValue);
 if (isQualPredefined) {
                        qualificationSelect.value = qualValue;
 qualificationOtherInput.classList.add('hidden');
                        qualificationOtherInput.required = false;
                        qualificationOtherInput.value = '';
                    } else if (qualValue) {
                        // Value is custom, set select to 'OTHER_QUAL' and show the input
                        qualificationSelect.value = 'OTHER_QUAL';
 qualificationOtherInput.classList.remove('hidden');
                        qualificationOtherInput.required = true;
                        qualificationOtherInput.value = qualValue;
                    } else {
                        qualificationSelect.value = '';
 // Reset if value is empty/null
                        qualificationOtherInput.classList.add('hidden');
 qualificationOtherInput.required = false;
                        qualificationOtherInput.value = '';
                    }
                    
                    console.log(`User data loaded successfully for Employee ID: ${employeeId}`);
 } else {
                    console.log(`No previous records found for Employee ID: ${employeeId}.`);
 }

            } catch (error) {
                console.error("Error fetching user data by Employee ID:", error);
// No need to show a message box, just log the error silently
            }
        };
/**
         * Toggles visibility of the 'Other Work Place' input field.
 */
        const toggleWorkPlaceOther = () => {
            if (workPlaceSelect.value === 'OTHER') {
                workPlaceOtherInput.classList.remove('hidden');
 workPlaceOtherInput.required = true;
            } else {
                workPlaceOtherInput.classList.add('hidden');
 workPlaceOtherInput.required = false;
                workPlaceOtherInput.value = ''; // Clear value when hidden
            }
        };
/**
         * Toggles visibility of the 'Other Qualification' input field.
 */
        const toggleQualificationOther = () => {
             if (qualificationSelect.value === 'OTHER_QUAL') {
                 qualificationOtherInput.classList.remove('hidden');
 qualificationOtherInput.required = true;
             } else {
                 qualificationOtherInput.classList.add('hidden');
 qualificationOtherInput.required = false;
                 qualificationOtherInput.value = ''; // Clear value when hidden
             }
        };
/**
         * Initializes Firebase (with Auth) and loads data.
 */
        const initializeFirebase = async () => {
            try {
                app = initializeApp(firebaseConfigFromEnv);
 db = getFirestore(app);
                auth = getAuth(app);
                
                // Use session persistence so the login state remains during the session
                await setPersistence(auth, browserSessionPersistence);
 if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
 } else {
                    await signInAnonymously(auth);
 }

                userId = auth.currentUser?.uid ||
 crypto.randomUUID();
                
                loadCourses();
                loadAttendanceRecords();
                
                isReady = true;
                submitButton.disabled = courseNameSelect.options.length <= 1;
// Disable if only the default option is present
                buttonText.textContent = "تسجيل الحضور";
 } catch (error) {
                console.error("Firebase Initialization Error:", error);
 showMessage("خطأ في الاتصال", "حدث خطأ أثناء الاتصال بالنظام: " + error.message, false);
                isReady = false;
 }
        };

        /**
         * Handles the form submission and saves data to Firestore.
 */
        const handleSubmit = async (event) => {
            event.preventDefault();
 if (!isReady) {
                showMessage("النظام غير جاهز", "الرجاء الانتظار حتى يتم تحميل النظام.", false);
 return;
            }

            // Basic client-side validation for required fields
            if (!form.checkValidity()) {
                showMessage("خطأ في البيانات", "الرجاء تعبئة جميع الحقول الإلزامية المشار إليها بعلامة (*) بشكل صحيح.", false);
 form.reportValidity();
                return;
            }
            if (courseNameSelect.value === "") {
                showMessage("خطأ في البيانات", "الرجاء اختيار اسم الدورة من القائمة.", false);
 courseNameSelect.focus();
                return;
            }
            
            // Signature check
            const employeeId = employeeIdInput.value.trim();
 const signature = document.getElementById('signature').value.trim();

            if (employeeId !== signature) {
                showMessage("خطأ في التوقيع", "يجب أن يكون حقل التوقيع (الرقم الوظيفي) مطابقاً للرقم الوظيفي المدخل في الأعلى.", false);
 document.getElementById('signature').focus();
                return;
            }

            // Gather form data
            const formData = new FormData(form);
 const data = {};

            // 1. Custom logic for workPlace: use the 'Other' input value if 'OTHER' is selected
            let finalWorkPlace = workPlaceSelect.value;
 if (finalWorkPlace === 'OTHER') {
                finalWorkPlace = workPlaceOtherInput.value.trim();
 }

            // 2. Custom logic for Qualification: use the 'Other' input value if 'OTHER_QUAL' is selected
            let finalQualification = qualificationSelect.value;
 if (finalQualification === 'OTHER_QUAL') {
                finalQualification = qualificationOtherInput.value.trim();
 }


            // Process form entries, skipping the temporary 'other' fields
            for (const [key, value] of formData.entries()) {
                if (key !== 'workPlaceOther' && key !== 'qualificationOther' && key !== 'signature') {
                    data[key] = value.trim();
 }
            }
            // Overwrite workPlace and qualification with the final determined value
            data.workPlace = finalWorkPlace;
 data.qualification = finalQualification; // Save the final qualification value
            
            data.timestamp = serverTimestamp();
 data.userId = userId; 
            data.appId = appId;


            // Show loading state
            submitButton.disabled = true;
 buttonText.textContent = "جاري الإرسال...";
            loadingSpinner.classList.remove('hidden');
            
            try {
                // Ensure the workPlace value is the final determined one before saving
                const recordData = {
                    ...data,
                    workPlace: finalWorkPlace,
       
              qualification: finalQualification
                };
 const docRef = await addDoc(collection(db, ATTENDANCE_COLLECTION_PATH), recordData);
                
                console.log("Document successfully written with ID:", docRef.id);
// Success message
                showMessage("تم تسجيل الحضور بنجاح", "تم تسجيل بيانات الحضور في النظام.", true);
// Clear the form after successful submission
                form.reset();
 courseNameSelect.value = ""; 
                workPlaceSelect.value = ""; 
                qualificationSelect.value = ""; 
                
                // Clear and hide 'Other' fields
                workPlaceOtherInput.classList.add('hidden');
 workPlaceOtherInput.required = false;
                qualificationOtherInput.classList.add('hidden'); 
                qualificationOtherInput.required = false;

            } catch (error) {
                console.error("Error adding document: ", error);
 showMessage("خطأ في التسجيل", `حدث خطأ أثناء حفظ البيانات: ${error.message}.`, false);
 } finally {
                // Reset loading state
                loadingSpinner.classList.add('hidden');
 buttonText.textContent = "تسجيل الحضور";
                if (isReady && courseNameSelect.options.length > 1) submitButton.disabled = false;
 }
        };

        // Attach event listeners
        form.addEventListener('submit', handleSubmit);
 courseForm.addEventListener('submit', handleAddCourse);
        
        // EVENT LISTENERS for dynamic fields
        employeeIdInput.addEventListener('change', fetchUserDataByEmployeeId); 
        workPlaceSelect.addEventListener('change', toggleWorkPlaceOther);
 qualificationSelect.addEventListener('change', toggleQualificationOther); 
        
        // Initial Firebase setup call
        initializeFirebase();
// Initial state check for submit button
        if (!isReady) {
            buttonText.textContent = "جاري التحميل...";
 submitButton.disabled = true;
        }

    </script>
</body>
</html>
