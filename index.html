<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسجيل الحضور وإدارة الدورات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
body {
            font-family: 'Cairo', sans-serif;
            min-height: 100vh;
}
        /* تعديلات نمط خاصة للنموذج */
        input:focus, select:focus {
            border-color: #3b82f6 !important;
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .rtl-input::placeholder {
            text-align: right;
}
    </style>
</head>
<body class="bg-gray-50 flex items-start justify-center p-4">

    <div id="appContainer" class="w-full max-w-lg md:max-w-4xl bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-blue-100 transition-all duration-300 mt-8">

        <header class="mb-6 border-b pb-4 border-blue-200 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-700 mb-1 leading-tight" id="mainTitle">نموذج تسجيل 
الحضور</h1>
                <h2 class="text-lg font-medium text-gray-600">شعبة التعليم والتدريب والتطوير الفني والإداري</h2>
            </div>
            <button id="viewToggle" onclick="window.switchView('admin')"
                    class="bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
  
لوحة المشرف
            </button>
        </header>

        <div class="mb-4 text-xs text-gray-500 bg-gray-100 p-2 rounded hidden" id="userIdDisplay">
            <span class="font-semibold text-gray-700">معرف المستخدم (للتتبع):</span> <span id="currentUserId">N/A</span>
        </div>

      
  <div id="messageBox" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-40 hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
            <div id="messageContent" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center transform transition-transform duration-300 scale-95">
                <h3 id="messageTitle" class="text-xl font-bold mb-3"></h3>
                <p id="messageBody" class="text-gray-700 mb-4"></p>
    
            <button onclick="document.getElementById('messageBox').classList.add('hidden', 'opacity-0');
document.getElementById('messageBox').classList.remove('opacity-100');"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150">
                    حسناً
                </button>
            </div>
        </div>
        
     
   <div id="confirmBox" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-40 hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center transform transition-transform duration-300 scale-95" dir="rtl">
                <h3 class="text-xl font-bold mb-3 text-red-600">تأكيد الحذف</h3>
                <p id="confirmBody" class="text-gray-700 mb-4"></p>
  
               <div class="flex justify-center space-x-4 space-x-reverse">
                    <button id="confirmYes" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150">
                        نعم، احذف
                    </button>
        
            <button id="confirmNo" onclick="document.getElementById('confirmBox').classList.add('hidden', 'opacity-0');
document.getElementById('confirmBox').classList.remove('opacity-100');"
                            class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150">
                        إلغاء
                    </button>
                </div>
     
        </div>
        </div>

        <div id="userView">

            <p class="text-sm italic text-gray-500 mt-2 mb-4">الرجاء تسجيل المعلومات بدقة واكتمال.</p>

            <div class="required-note p-3 bg-red-50 text-red-700 border-r-4 border-red-400 rounded-lg mb-6 text-sm">
                الأسئلة التي تحمل علامة (<span class="text-red-600 font-bold">*</span>) هي أسئلة إلزامية.
            </div>

            <form id="attendanceForm" class="space-y-5">

                <div class="form-group">
                    <label for="courseName" class="block text-sm font-semibold text-gray-700 mb-2">اسم الدورة أو المحاضرة <span class="text-red-500">*</span></label>
                    <select id="courseName" name="courseName" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 
transition duration-150 bg-white cursor-pointer"
                            disabled>
                        <option value="" disabled selected>-- الرجاء اختيار اسم الدورة --</option>
                        </select>
                </div>
                
                <div class="form-group">
                
     <label for="employeeIdEn" class="block text-sm font-semibold text-gray-700 mb-2">الرقم الوظيفي (باللغة الإنجليزية) <span class="text-red-500">*</span></label>
                    <input type="text" id="employeeIdEn" name="employeeIdEn" required pattern="[0-9]*" inputmode="numeric"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                       
     dir="ltr" placeholder="Example: 12345">
                </div>

                <div class="form-group">
                    <label for="nameAr" class="block text-sm font-semibold text-gray-700 mb-2">الاسم الثلاثي باللغة العربية <span class="text-red-500">*</span></label>
         
            <input type="text" id="nameAr" name="nameAr" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           placeholder="أدخل اسمك الثلاثي">
                </div>

     
            <div class="form-group">
                    <label for="nameEn" class="block text-sm font-semibold text-gray-700 mb-2">الاسم الثلاثي باللغة الإنجليزية (لغايات ساعات التطوير المهني)</label>
                    <input type="text" id="nameEn" name="nameEn"
           
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                           dir="ltr" placeholder="Enter your full name">
                </div>
                
            
     <div class="form-group">
                    <label for="nationalIdEn" class="block text-sm font-semibold text-gray-700 mb-2">الرقم الوطني باللغة الإنجليزية <span class="text-red-500">*</span></label>
                    <input type="text" id="nationalIdEn" name="nationalIdEn" required pattern="[0-9]*" inputmode="numeric"
                  
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                           dir="ltr" placeholder="Example: 9876543210">
                </div>

                <div class="form-group space-y-3">
                    <label for="workPlace" class="block text-sm font-semibold text-gray-700 mb-2">مكان العمل <span class="text-red-500">*</span></label>
                    <select id="workPlace" name="workPlace" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-white cursor-pointer">
       
                  <option value="" disabled selected>-- الرجاء اختيار مكان العمل --</option>
                        <option value="دائرة الباطنية">دائرة الباطنية</option>
                        <option value="دائره طب الاسنان">دائرة طب الأسنان</option>
                   
          <option value="دائرة المختبرات الطبية والطب الشرعي">دائرة المختبرات الطبية والطب الشرعي</option>
                        <option value="دائرة الخدمات الطبية المساندة">دائرة الخدمات الطبية المساندة</option>
                        <option value="دائرة التخدير والانعاش">دائرة التخدير والإنعاش</option>
                        <option value="دائرة 
 الاشعه والطب النووي">دائرة الأشعة والطب النووي</option>
                        <option value="دائرة طب التاهيل">دائرة طب التأهيل</option>
                        <option value="مكتب البحث العلمي والدراسات الدوائية">مكتب البحث العلمي والدراسات الدوائية</option>
                        <option value="دائرة الصيدلة / بكالوريس صيدلة - د.صيدله">دائرة الصيدلة 
 / بكالوريوس صيدلة - د. صيدلة</option>
                        <option value="دائرة الصيدلة / دبلوم">دائرة الصيدلة / دبلوم</option>
                        <option value="دائرة الشؤون المالية">دائرة الشؤون المالية</option>
                        <option value="مكتب الجودة ومراقبة النوعية">مكتب الجودة ومراقبة النوعية</option>
    
                     <option value="مكتب السيطرة على العدوى">مكتب السيطرة على العدوى</option>
                        <option value="مكتب السلامة العامة والبيئة">مكتب السلامة العامة والبيئة</option>
                        <option value="دائرة الموارد البشرية">دائرة الموارد البشرية</option>
             
            <option value="مكتب العلاقات العامة">مكتب العلاقات العامة</option>
                        <option value="مكتب المعلومات والحاسوب">مكتب المعلومات والحاسوب</option>
                        <option value="مكتب الرقابة والتدقيق">مكتب الرقابة والتدقيق</option>
                        <option value="دائرة 
 العطاءات والتزويد">دائرة العطاءات والتزويد</option>
                        <option value="دائرة الهندسة والصيانة والتشغيل">دائرة الهندسة والصيانة والتشغيل</option>
                        <option value="دائرة شؤون المرضى">دائرة شؤون المرضى</option>
                        <option value="دائرة الخدمات المساندة">دائرة الخدمات المساندة</option>
        
                 <option value="دائرة الخدمات الفندقية">دائرة الخدمات الفندقية</option>
                        <option value="موظف جامعة اردنية">موظف جامعة أردنية</option>
                        <option value="OTHER">أخرى (يرجى التحديد)</option>
                    </select>

   
                  <input type="text" id="workPlaceOther" name="workPlaceOther" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 hidden"
                  
          placeholder="الرجاء تحديد مكان العمل الآخر" 
                           data-original-name="workPlace"> 
                </div>

                <div class="form-group">
     
                <label for="jobTitle" class="block text-sm font-semibold text-gray-700 mb-2">المسمى الوظيفي</label>
                    <input type="text" id="jobTitle" name="jobTitle"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                    
        placeholder="حسب ما هو مكتوب في الباجة التعريفية">
                </div>
                
                <div class="form-group space-y-3">
               
      <label for="qualification" class="block text-sm font-semibold text-gray-700 mb-2">درجة المؤهل العلمي <span class="text-red-500">*</span></label>
                    <select id="qualification" name="qualification" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-white cursor-pointer">
                        
<option value="" disabled selected>-- اختر درجة المؤهل --</option>
                        <option value="دبلوم">دبلوم</option>
                        <option value="بكالوريوس">بكالوريوس</option>
                        <option value="دراسات عليا">دراسات عليا (ماجستير/دكتوراه)</option>
               
          <option value="OTHER_QUAL">أخرى (يرجى التحديد)</option>
                    </select>

                    <input type="text" id="qualificationOther" name="qualificationOther" 
                  
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 hidden"
                           placeholder="الرجاء تحديد المؤهل العلمي الآخر" 
                           data-original-name="qualification">
                </div>

       
          <div class="form-group">
                    <label for="phoneEn" class="block text-sm font-semibold text-gray-700 mb-2">رقم الهاتف (باللغة الإنجليزية)</label>
                    <input type="tel" id="phoneEn" name="phoneEn" pattern="[0-9]*" inputmode="tel"
             
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                           dir="ltr" placeholder="Example: 79xxxxxxx">
                </div>
                
                
 <div class="form-group">
                    <label for="signature" class="block text-sm font-semibold text-gray-700 mb-2">التوقيع (الرقم الوظيفي بالإنجليزية) <span class="text-red-500">*</span></label>
                    <input type="text" id="signature" name="signature" required pattern="[0-9]*" inputmode="numeric"
                   
         class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-left"
                           dir="ltr" placeholder="أعد إدخال الرقم الوظيفي للتوقيع">
                </div>

                <button type="submit" id="submitButton"
                        class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-green-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-500/50 flex items-center justify-center disabled:opacity-50"
                        disabled>
                    <span id="buttonText">تسجيل الحضور</span>
         
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 
 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>

        <div id="adminView" class="hidden max-w-full md:max-w-4xl" style="direction: ltr;">
            <button onclick="window.switchView('user')"
                    class="bg-gray-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-150 mb-6 shadow-md"
                    dir="rtl">
                <span class="inline-block transform rotate-180 mr-2">⮞</span>
         
        العودة لنموذج الحضور
            </button>

            <div class="bg-blue-50 p-6 rounded-xl mb-8 border-l-4 border-blue-400">
                <h3 class="text-xl font-bold text-blue-700 mb-4" dir="rtl">إدارة الدورات / المحاضرات</h3>
                <form id="courseForm" class="flex flex-col md:flex-row 
 gap-3" dir="rtl">
                    <input type="text" id="newCourseName" required placeholder="أدخل اسم الدورة الجديدة"
                           class="flex-grow p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right"
                           dir="rtl">
           
          <button type="submit" id="addCourseButton"
                            class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50 min-w-[150px]">
                        إضافة دورة
                    </button>
  
               </form>
                <div class="mt-4 p-3 bg-white rounded-lg shadow-inner">
                    <h4 class="font-semibold text-gray-700 mb-2" dir="rtl">الدورات الحالية:</h4>
                    <ul id="courseList" class="space-y-1 text-sm text-gray-600" dir="rtl">
               
          <li class="text-center text-gray-400">جاري التحميل...</li>
                    </ul>
                </div>
            </div>

         
    <div class="mt-8">
                <div class="flex justify-between items-center mb-4" dir="rtl">
                    <h3 class="text-xl font-bold text-gray-700">سجلات الحضور (<span id="recordCount">0</span> تسجيل)</h3>
                    <button id="exportButton" onclick="window.exportRecordsToSheet()"
                            class="bg-purple-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center disabled:opacity-50"
                            title="تصدير جميع السجلات مباشرة إلى Google Sheets">
            
             <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M12 18V12"/><path d="M9 15h6"/></svg>
                        تصدير مباشر لـ Sheets
                    </button>
    
                 </div>
                <div class="overflow-x-auto bg-white rounded-lg shadow-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200 text-right text-sm" dir="rtl">
                
         <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">التاريخ</th>
                          
       <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">اسم الدورة</th> <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">الرقم الوظيفي</th>
                                <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">الاسم (عربي)</th>
        
                         <th class="px-3 py-3 text-gray-500 uppercase tracking-wider">مكان العمل</th>
                            </tr>
                        </thead>
                  
       <tbody id="attendanceRecordsTable" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">جاري تحميل السجلات...</td></tr>
                        </tbody>
                    </table>
            
     </div>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <script>
        // ----------------------------------------------------------------
        // NOTE: Firebase Config and App ID are now hardcoded based on user's request.
// ----------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBRbLWcAFNAGHAIi5DRwCGDp4f7o4H4ZP8",
            authDomain: "attendance-training-log.firebaseapp.com",
            projectId: "attendance-training-log",
            storageBucket: "attendance-training-log.firebasestorage.app",
            messagingSenderId: "281858319933",
            appId: "1:281858319933:web:dd2b5b6af852b65ac2ac54"
        };
// ***************************************************************
        // ** التعديل الهام: تم وضع رابط النشر لسكريبت Google Apps Script هنا **
        // ***************************************************************
        const GOOGLE_SHEETS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbysm_czs0mxTumCBUcfxTSf3XmMFiwbCu4X6HE8G9HnckbGHd-ZY9pYc7UzoDwAZm2z2g/exec';
// ***************************************************************

        // Global variables provided by the environment (using project ID as app ID for simplicity here)
        const appId = typeof __app_id !== 'undefined' ?
 __app_id : 'default-app-id';
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // CORRECT ACCESS METHODS for standard (non-module) SDK:
        const initializeApp = firebase.initializeApp;
        // Auth Functions
        const getAuth = firebase.auth.getAuth;
        const signInAnonymously = firebase.auth.signInAnonymously;
        const signInWithCustomToken = firebase.auth.signInWithCustomToken;
        const setPersistence = firebase.auth.setPersistence;
        const browserSessionPersistence = firebase.auth.browserSessionPersistence;

        // Firestore Functions
        const getFirestore = firebase.firestore.getFirestore;
        const collection = firebase.firestore.collection;
        const addDoc = firebase.firestore.addDoc;
        const setLogLevel = firebase.firestore.setLogLevel;
        const onSnapshot = firebase.firestore.onSnapshot;
        const query = firebase.firestore.query; // This is the original name
        const serverTimestamp = firebase.firestore.serverTimestamp;
        const getDocs = firebase.firestore.getDocs;
        const where = firebase.firestore.where;
        const doc = firebase.firestore.doc;
        const deleteDoc = firebase.firestore.deleteDoc;
        const updateDoc = firebase.firestore.updateDoc;
        // Renaming query function to avoid local scope conflict (as was done in the original module code)
        const firestoreQuery = firebase.firestore.query; 

        
        // Set log level for debugging
        setLogLevel('Debug');
// Initialize Firebase variables
        let app, db, auth, userId = 'anonymous';
 let isReady = false; 

        // Global variable to hold records for export
        let currentRecords = [];
// مسارات Firestore الآمنة التي تتطابق مع قواعد الأمان في بيئة Canvas
        // --- START MODIFICATION ---
        // When running outside the Canvas environment (e.g., as a local file),
        // we use simple root collection names instead of the complex Canvas path.
 const ATTENDANCE_COLLECTION = 'attendance_records'; // اسم المجموعة المحلي [cite: 78]
        const COURSES_COLLECTION = 'courses';
// اسم المجموعة المحلي [cite: 79]
        
        // Check if we are in the Canvas environment by checking __app_id
        const isCanvasEnvironment = typeof __app_id !== 'undefined' && __app_id !== 'default-app-id';
 const getCollectionPath = (collectionName) => {
            if (isCanvasEnvironment) {
                return `/artifacts/${appId}/public/data/${collectionName}`;
 }
            // Use simple root collection name if not in Canvas
            return collectionName;
 };
        
        const ATTENDANCE_COLLECTION_PATH = getCollectionPath(ATTENDANCE_COLLECTION);
        const COURSES_COLLECTION_PATH = getCollectionPath(COURSES_COLLECTION);
        // --- END MODIFICATION ---


        // UI elements
        const employeeIdInput = document.getElementById('employeeIdEn'); [cite: 83]
 const nameArInput = document.getElementById('nameAr');
        const nameEnInput = document.getElementById('nameEn');
        const nationalIdInput = document.getElementById('nationalIdEn');
        const workPlaceSelect = document.getElementById('workPlace'); 
        const workPlaceOtherInput = document.getElementById('workPlaceOther');
 const jobTitleInput = document.getElementById('jobTitle'); [cite: 84]
        const phoneEnInput = document.getElementById('phoneEn');
        const qualificationSelect = document.getElementById('qualification'); 
        const qualificationOtherInput = document.getElementById('qualificationOther'); 
        
        const userView = document.getElementById('userView');
 const adminView = document.getElementById('adminView'); [cite: 85]
        const mainTitle = document.getElementById('mainTitle');
        const viewToggle = document.getElementById('viewToggle');
        const form = document.getElementById('attendanceForm');
        const courseForm = document.getElementById('courseForm');
 const courseNameSelect = document.getElementById('courseName'); [cite: 86]
        const courseListUl = document.getElementById('courseList');
        const recordsTableBody = document.getElementById('attendanceRecordsTable');
        const recordCountSpan = document.getElementById('recordCount');
        const submitButton = document.getElementById('submitButton');
 const buttonText = document.getElementById('buttonText'); [cite: 87]
        const loadingSpinner = document.getElementById('loadingSpinner');
        const exportButton = document.getElementById('exportButton');
// Global variable to store confirmation callback [cite: 88]
        let confirmCallback = null;
// Event listener for the "Yes" button in the confirm modal [cite: 89]
        document.getElementById('confirmYes')?.addEventListener('click', () => {
            document.getElementById('confirmBox').classList.add('hidden', 'opacity-0');
            document.getElementById('confirmBox').classList.remove('opacity-100');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
      
       } [cite: 90]
        });
// Function to show custom modal messages [cite: 91]
        const showMessage = (title, body, isSuccess = false) => {
            const messageBox = document.getElementById('messageBox'); [cite: 91]
 const messageTitle = document.getElementById('messageTitle'); [cite: 92]
            const messageBody = document.getElementById('messageBody'); [cite: 92]
            const button = messageBox.querySelector('button'); [cite: 92]

            messageTitle.textContent = title; [cite: 92]
            messageBody.textContent = body; [cite: 92]
// Set style based on success/error [cite: 93]
            messageTitle.classList.remove('text-red-600', 'text-green-600'); [cite: 93]
 button.classList.remove('bg-blue-600', 'bg-green-600'); [cite: 94]

            if (isSuccess) { [cite: 94]
                messageTitle.classList.add('text-green-600'); [cite: 94]
 button.classList.add('bg-green-600'); [cite: 95]
            } else { [cite: 95]
                messageTitle.classList.add('text-red-600'); [cite: 95]
 button.classList.add('bg-blue-600'); [cite: 96]
            }

            // Show the modal
            messageBox.classList.remove('hidden'); [cite: 96]
 setTimeout(() => messageBox.classList.add('opacity-100'), 10); [cite: 97]
        };
        
        // Function to show custom confirmation modal
        const showConfirm = (body, onConfirm) => {
            const confirmBox = document.getElementById('confirmBox'); [cite: 97]
 document.getElementById('confirmBody').textContent = body; [cite: 98]
            confirmCallback = onConfirm; [cite: 98]

            confirmBox.classList.remove('hidden'); [cite: 98]
            setTimeout(() => confirmBox.classList.add('opacity-100'), 10); [cite: 98]
        };
/**
         * Helper function to generate action buttons for a course item. [cite: 99]
 * تم تعريفها كـ window.function لجعلها متاحة لـ onclick في العناصر التي يتم إنشاؤها ديناميكياً. [cite: 100, 101]
 */
        window.getCourseActionButtons = (id, name) => {
            const escapedName = name.replace(/'/g, "\\'"); [cite: 101]
 return `
                <button onclick="window.handleEditCourse('${id}', '${escapedName}')" 
                        class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition duration-150" title="تعديل">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 
 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg> [cite: 102, 103]
                </button>
                <button onclick="window.handleDeleteCourse('${id}', '${escapedName}')" 
                        class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150" title="حذف">
               
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> [cite: 104]
                </button>
            
 `; [cite: 105]
        };


        /**
         * Switches the application view between 'user' and 'admin'. [cite: 106]
 */
        window.switchView = (view) => {
            if (view === 'admin') {
                userView.classList.add('hidden'); [cite: 106]
 adminView.classList.remove('hidden'); [cite: 107]
                mainTitle.textContent = 'لوحة تحكم المشرف'; [cite: 107]
                viewToggle.textContent = 'نموذج الحضور'; [cite: 107]
                viewToggle.onclick = () => window.switchView('user'); [cite: 107]
                document.getElementById('userIdDisplay').classList.remove('hidden'); [cite: 107]
                document.getElementById('currentUserId').textContent = userId; [cite: 107]
 } else { // user view
                adminView.classList.add('hidden'); [cite: 108]
 userView.classList.remove('hidden'); [cite: 109]
                mainTitle.textContent = 'نموذج تسجيل الحضور'; [cite: 109]
                viewToggle.textContent = 'لوحة المشرف'; [cite: 109]
                viewToggle.onclick = () => window.switchView('admin'); [cite: 109]
                document.getElementById('userIdDisplay').classList.add('hidden'); [cite: 109, 110]
 }
        };

        /**
         * Loads courses from Firestore and populates the select dropdown and Admin list. [cite: 110, 111]
 */
        const loadCourses = () => {
            if (!db) return; [cite: 111]
 const q = query(collection(db, COURSES_COLLECTION_PATH)); [cite: 112]
            
            // onSnapshot for real-time updates [cite: 112]
            onSnapshot(q, (snapshot) => { [cite: 112]
                const courses = []; [cite: 112]
                const courseDocs = {}; // Store docId and name for CRUD operations [cite: 112]
                snapshot.forEach((doc) => {
            
         const data = doc.data(); [cite: 113]
                    courses.push(data.name); [cite: 113]
                    courseDocs[data.name] = { id: doc.id, name: data.name }; [cite: 113]
                });

                // 1. Populate User Dropdown [cite: 113]
      
           courseNameSelect.innerHTML = '<option value="" disabled selected>-- الرجاء اختيار اسم الدورة --</option>'; [cite: 114]
                courses.sort().forEach(course => { [cite: 114]
                    const option = document.createElement('option'); [cite: 114]
                    option.value = course; [cite: 114]
                 
    option.textContent = course; [cite: 115]
                    courseNameSelect.appendChild(option); [cite: 115]
                });
                
                // تم تمكين زر الإرسال بناءً على جاهزية النظام [cite: 115]
                submitButton.disabled = !isReady 
 || courses.length === 0; [cite: 116] 
                courseNameSelect.disabled = false; [cite: 116]

                // 2. Populate Admin List [cite: 116]
                courseListUl.innerHTML = ''; [cite: 116]
 if (courses.length > 0) { [cite: 117]
                    courses.sort().forEach(courseName => { [cite: 117]
                        const course = courseDocs[courseName]; [cite: 117]
                        const li = document.createElement('li'); [cite: 117]
                    
     li.id = `course-item-${course.id}`; [cite: 118]
                        li.className = "flex items-center justify-between border-b last:border-b-0 py-2 group"; [cite: 118]
                        li.dir = "rtl"; // Ensure proper RTL alignment [cite: 118]
                        
       
                  // --- START OF MODIFICATION --- [cite: 118, 119]
                        // SIMPLIFIED: Always render the standard view. [cite: 119, 120]
                        // This prevents data conflicts during real-time updates if an item is being edited. [cite: 120]
          
                // Any in-progress edit will be safely cancelled by the snapshot re-render. [cite: 120]
                        li.innerHTML = `
                            <span id="course-name-${course.id}" class="truncate text-base font-medium text-gray-800">${course.name}</span>
                
             <div id="course-actions-${course.id}" class="flex space-x-2 space-x-reverse min-w-[50px] items-center justify-end">
                                ${window.getCourseActionButtons(course.id, course.name)}
                            </div>
                    
     `; [cite: 121, 122]
                        // --- END OF MODIFICATION --- [cite: 122]

                        courseListUl.appendChild(li); [cite: 122, 123]
 });
                } else {
                    courseListUl.innerHTML = '<li class="text-center py-2 text-gray-400">لا توجد دورات مسجلة بعد.</li>'; [cite: 123, 124]
 }

                console.log(`Loaded ${courses.length} courses.`); [cite: 124]
 }, (error) => {
                console.error("Error loading courses:", error); [cite: 125]
 showMessage("خطأ في الدورات", "فشل تحميل قائمة الدورات. يرجى التأكد من أن الاتصال بالإنترنت فعال.", false); [cite: 126]
            });
        };
/**
         * Handles deleting a course from Firestore using a custom confirmation modal. [cite: 127, 128]
 */
        window.handleDeleteCourse = async (courseId, courseName) => { [cite: 128]
            showConfirm(
                `هل أنت متأكد من حذف الدورة: "${courseName}"؟ سيؤدي هذا إلى إزالة الدورة من قائمة الاختيارات لجميع المستخدمين، لكنه لن يحذف سجلات الحضور السابقة التي تستخدمها.`,
                async () => {
               
      // Logic executed on confirmation [cite: 129]
                    const courseItem = document.getElementById(`course-item-${courseId}`); [cite: 129]
                    if (courseItem) { [cite: 129]
                        courseItem.style.opacity = '0.5'; [cite: 129]
                    
    courseItem.style.pointerEvents = 'none'; [cite: 130]
                    }

                    try { [cite: 130]
                        await deleteDoc(doc(db, COURSES_COLLECTION_PATH, courseId)); [cite: 130]
                        showMessage("تم الحذف 
 بنجاح", `تم حذف الدورة: "${courseName}".`, true); [cite: 131]
                    } catch (error) { [cite: 131]
                        console.error("Error deleting course: ", error); [cite: 131]
                        showMessage("خطأ في الحذف", `حدث خطأ أثناء حذف الدورة: ${error.message}.`, false); [cite: 132]
 }
                    // The onSnapshot listener handles the final UI removal/re-render. [cite: 132, 133]
 }
            );
        };
/**
         * Enables inline editing for a course name by replacing the text span with an input field. [cite: 134, 135]
 */
        window.handleEditCourse = (courseId, currentName) => {
            const nameSpan = document.getElementById(`course-name-${courseId}`); [cite: 135]
 const actionsDiv = document.getElementById(`course-actions-${courseId}`); [cite: 136]
            const listItem = document.getElementById(`course-item-${courseId}`); [cite: 136]

            if (!nameSpan || !actionsDiv || !listItem) return; [cite: 136]
// Hide the original span [cite: 137]
            nameSpan.classList.add('hidden'); [cite: 137]
// Create input field [cite: 138]
            const input = document.createElement('input'); [cite: 138]
 input.type = 'text'; [cite: 139]
            input.value = currentName; [cite: 139]
            input.id = `edit-input-${courseId}`; [cite: 139]
            input.className = 'flex-grow p-1 border border-blue-400 rounded-lg text-right focus:ring-blue-500 focus:border-blue-500'; [cite: 139]
 input.dir = 'rtl'; [cite: 140]
            input.required = true; [cite: 140]

            // Create temporary div to hold input [cite: 140]
            const tempEditDiv = document.createElement('div'); [cite: 140]
 tempEditDiv.id = `edit-div-${courseId}`; [cite: 141]
            tempEditDiv.className = "flex flex-grow items-center gap-2"; [cite: 141]
            tempEditDiv.appendChild(input); [cite: 141]
// Insert input field before action buttons [cite: 142]
            listItem.insertBefore(tempEditDiv, actionsDiv); [cite: 142]
// Change action buttons to Save and Cancel [cite: 143]
            // Note: The cancel button now calls loadCourses() to force a re-render from snapshot, [cite: 143]
            // which is safer and guaranteed to clean up the edit state. [cite: 144]
 actionsDiv.innerHTML = `
                <button onclick="window.handleSaveEdit('${courseId}', '${currentName.replace(/'/g, "\\'")}')" 
                        class="text-green-500 hover:text-green-700 p-1 rounded-full hover:bg-green-100 transition duration-150" title="حفظ التعديل">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="20 6 9 17 4 12"/></svg>
      
           </button>
                <button onclick="window.loadCourses()" 
                        class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150" title="إلغاء">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" 
 y1="6" y2="18"/></svg>
                </button>
            `; [cite: 145, 146]
 input.focus(); [cite: 147]
        };

        /**
         * Saves the edited course name to Firestore. [cite: 147, 148]
 */
        window.handleSaveEdit = async (courseId, originalName) => {
            const input = document.getElementById(`edit-input-${courseId}`); [cite: 148]
 const actionsDiv = document.getElementById(`course-actions-${courseId}`); [cite: 149]

            if (!input || !input.value.trim()) { [cite: 149]
                showMessage("خطأ في البيانات", "لا يمكن حفظ اسم دورة فارغ.", false); [cite: 149]
 return; [cite: 150]
            }
            
            const newName = input.value.trim(); [cite: 150, 151]
 if (newName === originalName) { [cite: 151]
                showMessage("إلغاء التعديل", "لم يتم حفظ التعديل: الاسم الجديد مطابق للاسم القديم.", false); [cite: 151]
// Trigger re-render to clean up edit fields
                loadCourses(); [cite: 152]
 return; [cite: 153]
            }
            
            input.disabled = true; [cite: 153]
 actionsDiv.style.opacity = '0.5'; [cite: 154] 

            try {
                // Check for duplication before updating
                const existingCourseQuery = firestoreQuery(collection(db, COURSES_COLLECTION_PATH), where('name', '==', newName)); [cite: 154, 155]
 const existingSnapshot = await getDocs(existingCourseQuery); [cite: 155]

                if (!existingSnapshot.empty) { [cite: 155]
                    // Check if the found document is the one we are editing.
 If not, it's a duplicate. [cite: 156]
                    let isDuplicate = false; [cite: 156]
                    existingSnapshot.forEach(doc => { [cite: 156]
                        if (doc.id !== courseId) { [cite: 156]
                            isDuplicate = true; [cite: 156]
                        }
       
              }); [cite: 157]
 if (isDuplicate) { [cite: 158]
                        showMessage("خطأ", `الدورة "${newName}" موجودة بالفعل لدورة أخرى.`, false); [cite: 158]
 input.disabled = false; [cite: 159]
                        actionsDiv.style.opacity = '1'; [cite: 159]
                        return; [cite: 159]
                    }
                }


                await updateDoc(doc(db, COURSES_COLLECTION_PATH, courseId), {
                    name: newName,
                    updatedAt: serverTimestamp() 
              
   }); [cite: 160]

                showMessage("تم الحفظ بنجاح", `تم تعديل اسم الدورة من "${originalName}" إلى "${newName}".`, true); [cite: 160, 161]
// The onSnapshot listener handles the final UI refresh. [cite: 161]
                
            } catch (error) { [cite: 161]
                console.error("Error saving course edit: ", error); [cite: 162]
 showMessage("خطأ في الحفظ", `حدث خطأ أثناء حفظ التعديل: ${error.message}.`, false); [cite: 162]
 } finally {
                // In case of error, re-enable (though onSnapshot will refresh anyway) [cite: 163]
                input.disabled = false; [cite: 163]
 actionsDiv.style.opacity = '1'; [cite: 164]
                // We don't call loadCourses() here because the onSnapshot listener [cite: 164]
                // will fire upon successful updateDoc and handle the UI refresh. [cite: 165]
// If there's an error, the user can click cancel (which calls loadCourses) [cite: 165]
                // or retry saving. [cite: 166]
 }
        };

        /**
         * Handles adding a new course to Firestore. [cite: 166, 167]
 */
        const handleAddCourse = async (event) => {
            event.preventDefault(); [cite: 167]
 const newCourseInput = document.getElementById('newCourseName'); [cite: 168]
            const courseName = newCourseInput.value.trim(); [cite: 168]
            const addCourseButton = document.getElementById('addCourseButton'); [cite: 168]

            if (!courseName) return; [cite: 168]

            addCourseButton.disabled = true; [cite: 168]
 addCourseButton.textContent = "جاري الإضافة..."; [cite: 169]

            try {
                // Check if course already exists (case-insensitive for a simple check) [cite: 169]
                const existingCourseQuery = firestoreQuery(collection(db, COURSES_COLLECTION_PATH), where('name', '==', courseName)); [cite: 169, 170]
 const existingSnapshot = await getDocs(existingCourseQuery); [cite: 170]
                
                if (!existingSnapshot.empty) { [cite: 170]
                    showMessage("خطأ", `الدورة "${courseName}" موجودة بالفعل.`, false); [cite: 170]
 return; [cite: 171]
                }
                
                await addDoc(collection(db, COURSES_COLLECTION_PATH), { [cite: 171]
                    name: courseName, [cite: 171]
                    createdAt: serverTimestamp() 
                }); [cite: 171]
 showMessage("تم بنجاح", `تم إضافة الدورة: "${courseName}"`, true); [cite: 172]
                newCourseInput.value = ''; [cite: 172]
// Clear input [cite: 173]
            } catch (error) { [cite: 173]
                console.error("Error adding course: ", error); [cite: 174]
 showMessage("خطأ في الإضافة", `حدث خطأ أثناء إضافة الدورة: ${error.message}.`, false); [cite: 174]
 } finally {
                addCourseButton.disabled = false; [cite: 175]
 addCourseButton.textContent = "إضافة دورة"; [cite: 176]
            }
        };
/**
         * Loads attendance records from Firestore for the Admin view. [cite: 177, 178]
 */
        const loadAttendanceRecords = () => {
            if (!db) return; [cite: 178]
// Query without orderBy to avoid index requirement [cite: 179]
            const q = query(collection(db, ATTENDANCE_COLLECTION_PATH)); [cite: 179]
// onSnapshot for real-time updates [cite: 180]
            onSnapshot(q, (snapshot) => { [cite: 180]
                recordsTableBody.innerHTML = ''; [cite: 180]
                
                currentRecords = []; // Clear global records [cite: 180]
                snapshot.forEach((doc) => { [cite: 180]
       
              currentRecords.push(doc.data()); [cite: 181]
                });

                // Sort by timestamp descending (in-memory sort required since orderBy is avoided) [cite: 181]
                currentRecords.sort((a, b) => {
                    const timeA = b.timestamp?.toDate ? 
 b.timestamp.toDate().getTime() : 0; [cite: 182]
                    const timeB = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0; [cite: 182]
                    return timeA - timeB; // Sort descending [cite: 182]
                });

                recordCountSpan.textContent = currentRecords.length; [cite: 182, 183]
           
       exportButton.disabled = currentRecords.length === 0; [cite: 183]

                if (currentRecords.length === 0) { [cite: 183]
                    recordsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">لا توجد سجلات حضور مسجلة.</td></tr>'; [cite: 184]
 return; [cite: 184]
                }

                currentRecords.forEach(record => { [cite: 184]
                    const row = document.createElement('tr'); [cite: 184]
                    row.className = 'hover:bg-gray-100 transition duration-100'; [cite: 184]

                    // Format timestamp
            
         const date = record.timestamp?.toDate ? record.timestamp.toDate() : new Date(); [cite: 185]
                    const formattedDate = date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); [cite: 185]
                    
                    // NEW TABLE ORDER: Date, Course Name, Employee ID, 
 Name Ar, Work Place [cite: 186]
                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap">${formattedDate}</td>
                        <td class="px-3 py-3 whitespace-nowrap">${record.courseName || '---'}</td>
                   
       <td class="px-3 py-3 whitespace-nowrap text-left" dir="ltr">${record.employeeIdEn || '---'}</td> [cite: 187]
                        <td class="px-3 py-3 whitespace-nowrap font-medium">${record.nameAr ||
 '---'}</td> [cite: 188]
                        <td class="px-3 py-3 whitespace-nowrap">${record.workPlace ||
 '---'}</td> [cite: 189]
                    `; [cite: 189]
 recordsTableBody.appendChild(row); [cite: 190]
                });

                console.log(`Loaded ${currentRecords.length} attendance records.`); [cite: 190]

            }, (error) => {
                console.error("Error loading attendance records:", error); [cite: 191]
 recordsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">خطأ في تحميل السجلات.</td></tr>'; [cite: 191]
 showMessage("خطأ في السجلات", "فشل تحميل سجلات الحضور. يرجى التأكد من أن الاتصال بالإنترنت فعال.", false); [cite: 192]
            });
        };
/**
         * Sends data to the Google Sheets Web App URL. [cite: 193]
 */
        window.exportRecordsToSheet = async () => {
            if (!GOOGLE_SHEETS_SCRIPT_URL) { [cite: 194]
                showMessage("خطأ في الإعداد", "لم يتم تعيين رابط Google Sheets Script URL في الكود.", false); [cite: 194]
 return; [cite: 195]
            }
            if (currentRecords.length === 0) { [cite: 195]
                showMessage("لا توجد بيانات", "لا توجد سجلات حضور لتصديرها.", false); [cite: 195]
 return; [cite: 196]
            }

            exportButton.disabled = true; [cite: 196]
            const originalText = exportButton.textContent; [cite: 196]
 exportButton.textContent = "جاري التصدير..."; [cite: 197]

            // Prepare records for sending, ensuring date is formatted correctly for Sheets [cite: 197]
            const formattedRecords = currentRecords.map(record => { [cite: 197]
                const date = record.timestamp?.toDate ? record.timestamp.toDate() : new Date(); [cite: 197]
                
                // Format date/time to include seconds for precise log
    
             const formattedDate = date.toLocaleDateString('ar-EG', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit' 
                }); [cite: 198]

               
  return { [cite: 199]
                    // This order is crucial and must match DEFAULT_HEADERS in sheets_exporter.js [cite: 199]
                    "التاريخ": formattedDate, [cite: 199]
                    "اسم الدورة": record.courseName || '', [cite: 199]
                    "الرقم الوظيفي": record.employeeIdEn 
 || '', [cite: 200]
                    "الاسم (عربي)": record.nameAr || '', [cite: 200]
                    "الاسم (إنجليزي)": record.nameEn || '', [cite: 200]
                    "الرقم الوطني": record.nationalIdEn ||
 '', [cite: 201]
                    "مكان العمل": record.workPlace ||
 '', [cite: 202]
                    "المسمى الوظيفي": record.jobTitle ||
 '', [cite: 203]
                    "المؤهل العلمي": record.qualification ||
 '', [cite: 204]
                    "رقم الهاتف": record.phoneEn ||
 '', [cite: 205]
                    "App ID": record.appId ||
 appId, [cite: 206]
                    "User ID": record.userId ||
 userId [cite: 207]
                };
            });
 try { [cite: 208]
                const response = await fetch(GOOGLE_SHEETS_SCRIPT_URL, { [cite: 208]
                    method: 'POST', [cite: 208]
                    mode: 'cors', [cite: 208]
                    headers: { 'Content-Type': 'application/json' }, [cite: 208]
            
         body: JSON.stringify({ records: formattedRecords }) [cite: 209]
                });
 const result = await response.json(); [cite: 210]

                if (result.status === 'success') { [cite: 210]
                    showMessage("نجاح التصدير!", `تم ترحيل ${currentRecords.length} سجل بنجاح إلى جدول البيانات.`, true); [cite: 211]
 } else {
                    console.error("Sheets Script Error:", result.message); [cite: 211]
 showMessage("فشل التصدير", `فشل سكريبت Sheets: ${result.message || 'حدث خطأ غير معروف في السكريبت.'}`, false); [cite: 212]
 }

            } catch (error) {
                console.error("Network/Fetch Error:", error); [cite: 213]
 showMessage("خطأ في الاتصال", `فشل في إرسال البيانات إلى Google Sheets: ${error.message}. تأكد من تفعيل الرابط.`, false); [cite: 214]
 } finally {
                exportButton.disabled = false; [cite: 215]
 exportButton.textContent = originalText; [cite: 216]
            }
        };
/**
         * Fetches user data based on employee ID and auto-fills the form. [cite: 217, 218]
 */
        const fetchUserDataByEmployeeId = async (event) => {
            const employeeId = event.target.value.trim(); [cite: 218]
// Clear fields if the input is empty or too short (assuming ID is 4+ digits) [cite: 219]
            if (employeeId.length < 4 || !/^\d+$/.test(employeeId)) { [cite: 219]
                // Clear fields only if they are not the current employee ID being typed [cite: 219]
                if (nameArInput.value) nameArInput.value = ''; [cite: 219]
 if (nameEnInput.value) nameEnInput.value = ''; [cite: 220]
                if (nationalIdInput.value) nationalIdInput.value = ''; [cite: 220]
                if (workPlaceSelect.value) workPlaceSelect.value = ''; [cite: 220] 
                workPlaceOtherInput.value = ''; [cite: 220]
// Clear workPlace other input [cite: 221]
                workPlaceOtherInput.classList.add('hidden'); [cite: 221]
 workPlaceOtherInput.required = false; [cite: 222] 
                if (jobTitleInput.value) jobTitleInput.value = ''; [cite: 222]
                if (phoneEnInput.value) phoneEnInput.value = ''; [cite: 222]
                if (qualificationSelect.value) qualificationSelect.value = ''; [cite: 222]
 qualificationOtherInput.value = ''; // Clear qualification other input [cite: 223]
                qualificationOtherInput.classList.add('hidden'); [cite: 223]
 qualificationOtherInput.required = false; [cite: 224]
                return; [cite: 224]
            }

            try {
                // الاستعلام: ابحث عن جميع السجلات التي تطابق الرقم الوظيفي [cite: 224]
                const q = firestoreQuery(
                    collection(db, ATTENDANCE_COLLECTION_PATH),
                  
   where('employeeIdEn', '==', employeeId) [cite: 225]
                );
 const snapshot = await getDocs(q); [cite: 226]

                if (!snapshot.empty) { [cite: 226]
                    const allRecords = []; [cite: 226]
 snapshot.forEach(doc => allRecords.push(doc.data())); [cite: 227]

                    // الفرز في الذاكرة (In-Memory Sort) للحصول على أحدث سجل [cite: 227]
                    allRecords.sort((a, b) => { [cite: 227]
                        const timeA = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0; [cite: 227]
                        const timeB = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0; [cite: 227]
   
                      return timeA - timeB; // Sort descending [cite: 228]
                    });
 const latestRecord = allRecords[0]; // أحدث سجل هو العنصر الأول بعد الفرز [cite: 229]
                    
                    // Auto-fill form fields with the latest data [cite: 229]
                    if (latestRecord.nameAr) nameArInput.value = latestRecord.nameAr; [cite: 229, 230]
 if (latestRecord.nameEn) nameEnInput.value = latestRecord.nameEn; [cite: 230]
                    if (latestRecord.nationalIdEn) nationalIdInput.value = latestRecord.nationalIdEn; [cite: 230] 
                    if (latestRecord.jobTitle) jobTitleInput.value = latestRecord.jobTitle; [cite: 230]
                    if (latestRecord.phoneEn) phoneEnInput.value = latestRecord.phoneEn; [cite: 230]
// --- 1. Handle workPlace auto-fill logic --- [cite: 231]
                    const workPlaceValue = latestRecord.workPlace ||
 ''; [cite: 232]
                    const predefinedWorkOptions = Array.from(workPlaceSelect.options).map(o => o.value); [cite: 232]
                    const isWorkPredefined = predefinedWorkOptions.includes(workPlaceValue); [cite: 233]
 if (isWorkPredefined) { [cite: 233]
                        workPlaceSelect.value = workPlaceValue; [cite: 233]
 workPlaceOtherInput.classList.add('hidden'); [cite: 234]
                        workPlaceOtherInput.required = false; [cite: 234]
                        workPlaceOtherInput.value = ''; [cite: 234]
                    } else if (workPlaceValue) { [cite: 234]
                        workPlaceSelect.value = 'OTHER'; [cite: 234]
 workPlaceOtherInput.classList.remove('hidden'); [cite: 235]
                        workPlaceOtherInput.required = true; [cite: 235]
                        workPlaceOtherInput.value = workPlaceValue; [cite: 235]
                    } else { [cite: 235]
                        workPlaceSelect.value = ''; [cite: 235]
 workPlaceOtherInput.classList.add('hidden'); [cite: 236]
                        workPlaceOtherInput.required = false; [cite: 236]
                        workPlaceOtherInput.value = ''; [cite: 236]
                    }
                    
                    // --- 2. Handle Qualification auto-fill logic --- [cite: 236]
                    const qualValue = latestRecord.qualification ||
 ''; [cite: 237]
                    const predefinedQualOptions = Array.from(qualificationSelect.options).map(o => o.value); [cite: 237]
                    const isQualPredefined = predefinedQualOptions.includes(qualValue); [cite: 238]
 if (isQualPredefined) { [cite: 238]
                        qualificationSelect.value = qualValue; [cite: 238]
 qualificationOtherInput.classList.add('hidden'); [cite: 239]
                        qualificationOtherInput.required = false; [cite: 239]
                        qualificationOtherInput.value = ''; [cite: 239]
                    } else if (qualValue) { [cite: 239]
                        // Value is custom, set select to 'OTHER_QUAL' and show the input [cite: 239]
                        qualificationSelect.value = 'OTHER_QUAL'; [cite: 239, 240]
 qualificationOtherInput.classList.remove('hidden'); [cite: 240]
                        qualificationOtherInput.required = true; [cite: 240]
                        qualificationOtherInput.value = qualValue; [cite: 240]
                    } else { [cite: 240]
                        qualificationSelect.value = ''; [cite: 241]
 // Reset if value is empty/null [cite: 241]
                        qualificationOtherInput.classList.add('hidden'); [cite: 241]
 qualificationOtherInput.required = false; [cite: 242]
                        qualificationOtherInput.value = ''; [cite: 242]
                    }
                    
                    console.log(`User data loaded successfully for Employee ID: ${employeeId}`); [cite: 242, 243]
 } else {
                    console.log(`No previous records found for Employee ID: ${employeeId}.`); [cite: 243, 244]
 }

            } catch (error) {
                console.error("Error fetching user data by Employee ID:", error); [cite: 244, 245]
// No need to show a message box, just log the error silently [cite: 245]
            }
        };
/**
         * Toggles visibility of the 'Other Work Place' input field. [cite: 246, 247]
 */
        const toggleWorkPlaceOther = () => {
            if (workPlaceSelect.value === 'OTHER') { [cite: 247]
                workPlaceOtherInput.classList.remove('hidden'); [cite: 247]
 workPlaceOtherInput.required = true; [cite: 248]
            } else {
                workPlaceOtherInput.classList.add('hidden'); [cite: 248]
 workPlaceOtherInput.required = false; [cite: 249]
                workPlaceOtherInput.value = ''; // Clear value when hidden [cite: 249]
            }
        };
/**
         * Toggles visibility of the 'Other Qualification' input field. [cite: 250, 251]
 */
        const toggleQualificationOther = () => {
             if (qualificationSelect.value === 'OTHER_QUAL') { [cite: 251]
                 qualificationOtherInput.classList.remove('hidden'); [cite: 251]
 qualificationOtherInput.required = true; [cite: 252]
             } else {
                 qualificationOtherInput.classList.add('hidden'); [cite: 252]
 qualificationOtherInput.required = false; [cite: 253]
                 qualificationOtherInput.value = ''; // Clear value when hidden [cite: 253]
             }
        };
/**
         * Initializes Firebase (with Auth) and loads data. [cite: 254, 255]
 */
        const initializeFirebase = async () => {
            try {
                app = initializeApp(firebaseConfigFromEnv); [cite: 255, 256]
 db = getFirestore(app); [cite: 256]
                auth = getAuth(app); [cite: 256]
                
                // Use session persistence so the login state remains during the session [cite: 256]
                await setPersistence(auth, browserSessionPersistence); [cite: 257]
 if (initialAuthToken) { [cite: 257]
                    await signInWithCustomToken(auth, initialAuthToken); [cite: 257, 258]
 } else {
                    await signInAnonymously(auth); [cite: 258, 259]
 }

                userId = auth.currentUser?.uid || [cite: 259]
 crypto.randomUUID(); [cite: 260]
                
                loadCourses(); [cite: 260]
                loadAttendanceRecords(); [cite: 260]
                
                isReady = true; [cite: 260]
                submitButton.disabled = courseNameSelect.options.length <= 1; [cite: 260, 261]
// Disable if only the default option is present [cite: 261]
                buttonText.textContent = "تسجيل الحضور"; [cite: 261, 262]
 } catch (error) {
                console.error("Firebase Initialization Error:", error); [cite: 262]
 showMessage("خطأ في الاتصال", "حدث خطأ أثناء الاتصال بالنظام: " + error.message, false); [cite: 263]
                isReady = false; [cite: 263]
 }
        };

        /**
         * Handles the form submission and saves data to Firestore. [cite: 264, 265]
 */
        const handleSubmit = async (event) => {
            event.preventDefault(); [cite: 265]
 if (!isReady) { [cite: 266]
                showMessage("النظام غير جاهز", "الرجاء الانتظار حتى يتم تحميل النظام.", false); [cite: 266]
 return; [cite: 267]
            }

            // Basic client-side validation for required fields [cite: 267]
            if (!form.checkValidity()) { [cite: 267]
                showMessage("خطأ في البيانات", "الرجاء تعبئة جميع الحقول الإلزامية المشار إليها بعلامة (*) بشكل صحيح.", false); [cite: 267]
 form.reportValidity(); [cite: 268]
                return; [cite: 268]
            }
            if (courseNameSelect.value === "") { [cite: 268]
                showMessage("خطأ في البيانات", "الرجاء اختيار اسم الدورة من القائمة.", false); [cite: 269]
 courseNameSelect.focus(); [cite: 269]
                return; [cite: 269]
            }
            
            // Signature check [cite: 269]
            const employeeId = employeeIdInput.value.trim(); [cite: 269, 270]
 const signature = document.getElementById('signature').value.trim(); [cite: 270]

            if (employeeId !== signature) { [cite: 270]
                showMessage("خطأ في التوقيع", "يجب أن يكون حقل التوقيع (الرقم الوظيفي) مطابقاً للرقم الوظيفي المدخل في الأعلى.", false); [cite: 270]
 document.getElementById('signature').focus(); [cite: 271]
                return; [cite: 271]
            }

            // Gather form data [cite: 271]
            const formData = new FormData(form); [cite: 271, 272]
 const data = {}; [cite: 272]

            // 1. Custom logic for workPlace: use the 'Other' input value if 'OTHER' is selected [cite: 272]
            let finalWorkPlace = workPlaceSelect.value; [cite: 272, 273]
 if (finalWorkPlace === 'OTHER') { [cite: 273]
                finalWorkPlace = workPlaceOtherInput.value.trim(); [cite: 273, 274]
 }

            // 2. Custom logic for Qualification: use the 'Other' input value if 'OTHER_QUAL' is selected [cite: 274]
            let finalQualification = qualificationSelect.value; [cite: 274, 275]
 if (finalQualification === 'OTHER_QUAL') { [cite: 275]
                finalQualification = qualificationOtherInput.value.trim(); [cite: 275, 276]
 }


            // Process form entries, skipping the temporary 'other' fields [cite: 276]
            for (const [key, value] of formData.entries()) { [cite: 276]
                if (key !== 'workPlaceOther' && key !== 'qualificationOther' && key !== 'signature') { [cite: 276]
                    data[key] = value.trim(); [cite: 277]
 }
            }
            // Overwrite workPlace and qualification with the final determined value [cite: 277]
            data.workPlace = finalWorkPlace; [cite: 277, 278]
 data.qualification = finalQualification; // Save the final qualification value [cite: 278]
            
            data.timestamp = serverTimestamp(); [cite: 278, 279]
 data.userId = userId; [cite: 279] 
            data.appId = appId; [cite: 279]


            // Show loading state [cite: 279]
            submitButton.disabled = true; [cite: 279, 280]
 buttonText.textContent = "جاري الإرسال..."; [cite: 280]
            loadingSpinner.classList.remove('hidden'); [cite: 280]
            
            try {
                // Ensure the workPlace value is the final determined one before saving [cite: 280]
                const recordData = { [cite: 280]
                    ...data, [cite: 281]
                    workPlace: finalWorkPlace,
       
              qualification: finalQualification [cite: 281]
                };
 const docRef = await addDoc(collection(db, ATTENDANCE_COLLECTION_PATH), recordData); [cite: 282]
                
                console.log("Document successfully written with ID:", docRef.id); [cite: 282, 283]
// Success message [cite: 283]
                showMessage("تم تسجيل الحضور بنجاح", "تم تسجيل بيانات الحضور في النظام.", true); [cite: 283, 284]
// Clear the form after successful submission [cite: 284]
                form.reset(); [cite: 284]
 courseNameSelect.value = ""; [cite: 285] 
                workPlaceSelect.value = ""; [cite: 285] 
                qualificationSelect.value = ""; [cite: 285] 
                
                // Clear and hide 'Other' fields [cite: 285]
                workPlaceOtherInput.classList.add('hidden'); [cite: 285, 286]
 workPlaceOtherInput.required = false; [cite: 286]
                qualificationOtherInput.classList.add('hidden'); [cite: 286] 
                qualificationOtherInput.required = false; [cite: 286]

            } catch (error) {
                console.error("Error adding document: ", error); [cite: 287]
 showMessage("خطأ في التسجيل", `حدث خطأ أثناء حفظ البيانات: ${error.message}.`, false); [cite: 287, 288]
 } finally {
                // Reset loading state [cite: 288]
                loadingSpinner.classList.add('hidden'); [cite: 288, 289]
 buttonText.textContent = "تسجيل الحضور"; [cite: 289]
                if (isReady && courseNameSelect.options.length > 1) submitButton.disabled = false; [cite: 289, 290]
 }
        };

        // Attach event listeners [cite: 290]
        form.addEventListener('submit', handleSubmit); [cite: 290]
 courseForm.addEventListener('submit', handleAddCourse); [cite: 291]
        
        // EVENT LISTENERS for dynamic fields [cite: 291]
        employeeIdInput.addEventListener('change', fetchUserDataByEmployeeId); [cite: 291] 
        workPlaceSelect.addEventListener('change', toggleWorkPlaceOther); [cite: 292]
 qualificationSelect.addEventListener('change', toggleQualificationOther); [cite: 292] 
        
        // Initial Firebase setup call [cite: 292]
        initializeFirebase(); [cite: 293]
// Initial state check for submit button [cite: 293]
        if (!isReady) { [cite: 293]
            buttonText.textContent = "جاري التحميل..."; [cite: 293, 294]
 submitButton.disabled = true; [cite: 294]
        }

    </script>
    </body>
</html>
